name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      target_version:
        description: 'Version to rollback to (leave empty for previous version)'
        required: false

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify rollback procedures exist
        run: |
          if [ ! -f "ROLLBACK_PROCEDURES.md" ]; then
            echo "Rollback procedures not found"
            exit 1
          fi
          echo "✓ Rollback procedures verified"
      
      - name: Check deployment history
        run: |
          echo "Checking deployment history for ${{ github.event.inputs.environment }}..."
          # This would typically query your deployment tracking system
          echo "✓ Deployment history available"

  rollback-staging:
    name: Rollback Staging
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: github.event.inputs.environment == 'staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine rollback version
        id: version
        run: |
          if [ -z "${{ github.event.inputs.target_version }}" ]; then
            # Get previous version from git tags
            PREVIOUS_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "main")
            echo "version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.target_version }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Rollback staging deployment
        env:
          STAGING_DEPLOY_KEY: ${{ secrets.STAGING_DEPLOY_KEY }}
          STAGING_DEPLOY_HOST: ${{ secrets.STAGING_DEPLOY_HOST }}
          STAGING_DEPLOY_USER: ${{ secrets.STAGING_DEPLOY_USER }}
          ROLLBACK_VERSION: ${{ steps.version.outputs.version }}
        run: |
          mkdir -p ~/.ssh
          echo "$STAGING_DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $STAGING_DEPLOY_HOST >> ~/.ssh/known_hosts
          
          ssh -i ~/.ssh/deploy_key $STAGING_DEPLOY_USER@$STAGING_DEPLOY_HOST << 'EOF'
            cd /app/vista
            echo "Rolling back to version: $ROLLBACK_VERSION"
            git fetch origin
            git checkout $ROLLBACK_VERSION
            docker-compose -f docker-compose.staging.yml pull
            docker-compose -f docker-compose.staging.yml up -d
            echo "✓ Staging rollback complete"
          EOF
      
      - name: Verify staging rollback
        env:
          STAGING_API_URL: ${{ secrets.STAGING_API_URL }}
        run: |
          echo "Verifying staging rollback..."
          for i in {1..30}; do
            if curl -f $STAGING_API_URL/health; then
              echo "✓ Staging rollback verified"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for service..."
            sleep 10
          done
          echo "✗ Staging rollback verification failed"
          exit 1

  rollback-production:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: github.event.inputs.environment == 'production'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine rollback version
        id: version
        run: |
          if [ -z "${{ github.event.inputs.target_version }}" ]; then
            # Get previous version from git tags
            PREVIOUS_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "main")
            echo "version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.target_version }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Confirm production rollback
        run: |
          echo "⚠️  PRODUCTION ROLLBACK INITIATED"
          echo "Rolling back to version: ${{ steps.version.outputs.version }}"
          echo "This action cannot be undone. Proceeding..."
      
      - name: Rollback Render deployment
        if: contains(github.event.inputs.environment, 'production')
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_ROLLBACK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "Render rollback hook not configured"
            exit 1
          fi
          
          echo "Triggering Render rollback..."
          curl -X POST $RENDER_DEPLOY_HOOK
          sleep 30
      
      - name: Verify production rollback
        env:
          PRODUCTION_API_URL: ${{ secrets.PRODUCTION_API_URL }}
        run: |
          echo "Verifying production rollback..."
          for i in {1..30}; do
            if curl -f $PRODUCTION_API_URL/health; then
              echo "✓ Production rollback verified"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for service..."
            sleep 10
          done
          echo "✗ Production rollback verification failed"
          exit 1

  notify-rollback:
    name: Notify Rollback
    runs-on: ubuntu-latest
    needs: [rollback-staging, rollback-production]
    if: always()
    
    steps:
      - name: Send rollback notification
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ github.event.inputs.environment }}';
            const version = '${{ github.event.inputs.target_version }}' || 'previous';
            const status = context.job.status;
            
            const message = `Rollback of ${environment} to ${version} ${status === 'success' ? '✓ completed' : '✗ failed'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            }).catch(() => {
              console.log('Could not post comment (not in PR context)');
            });
